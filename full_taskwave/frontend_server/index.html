<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>시간표 → 자동 폴더 생성 (서버 연동)</title>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    .apiBar{display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:10px}
    .apiBar input{max-width:420px}
    .ok{color:#059669}.bad{color:#dc2626}
    .note{color:#6b7280;font-size:13px}
    .mono{font-family:ui-monospace,Consolas,Menlo,monospace;white-space:pre-wrap}
    .hint{font-size:12px;color:#4b5563;margin-top:4px}
    details{margin-top:8px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-flex;gap:6px;align-items:center;border:1px solid #e5e7eb;border-radius:10px;padding:6px 10px}
    .chip input{margin:0}
  </style>
</head>
<body>
  <header>
    <h1>시간표 → 자동 폴더 생성 (서버 연동)</h1>
    <p class="sub">수동 입력 / OCR 업로드 / 웹(사이트) 중 하나로 시작 → 미리보기 → ZIP 생성</p>
  </header>

  <div class="apiBar">
    <label for="apiBase">API 서버</label>
    <input id="apiBase" type="text" placeholder="http://127.0.0.1:8000" />
    <button id="btnSaveApi">저장</button>
    <button id="btnPing">연결 확인</button>
    <span id="pingMsg"></span>
  </div>

  <main>
    <section class="card">
      <div class="tabs">
        <button class="tab active" id="tabManual">수동 입력</button>
        <button class="tab" id="tabUploadOcr">시간표 업로드(OCR)</button>
        <button class="tab" id="tabWeb">웹(사이트)</button>
      </div>

      <div id="panelManual">
        <h2>입력 (과목, 요일, 시작-끝)</h2>
        <textarea id="inputText" rows="8" placeholder="예) 데이터분석과응용, 화, 09:00-10:30&#10;품질공학, 금, 13:00-14:15"></textarea>
        <div class="grid">
          <div><label>시작일</label><input type="date" id="startDate" value="2025-09-01" /></div>
          <div><label>종료일</label><input type="date" id="endDate" value="2025-12-20" /></div>
        </div>
        <label>휴일(, 구분)</label><input type="text" id="holidays" placeholder="YYYY-MM-DD, YYYY-MM-DD" />
        <div><input type="checkbox" id="writeMeta" checked /> 메타 파일 생성</div>
        <div class="actions">
          <button id="btnPreview">미리보기</button>
          <button id="btnDownload">ZIP 다운로드</button>
        </div>
        <div class="errors" id="errors" hidden></div>
      </div>

      <div id="panelUploadOcr" class="hide">
        <h2>시간표 이미지/PDF 업로드 (OCR)</h2>
        <input id="fileInputOcr" type="file" accept="image/*,.pdf" />
        <p class="note">※ OCR은 이미지 품질/폰트에 따라 오류가 있을 수 있습니다. 결과를 확인 후 수동으로 고쳐서 사용하세요.</p>
        <div class="actions">
          <button id="btnParseOcr">업로드 파싱</button>
          <button id="btnApplyOcr" disabled>결과를 입력 칸에 반영</button>
        </div>
        <label>OCR 결과 (수동 입력 포맷)</label>
        <textarea id="ocrResult" rows="8" placeholder="(업로드 후 결과가 여기에 표시됩니다)"></textarea>
      </div>

      <div id="panelWeb" class="hide">
        <h2>웹에서 시간표 가져오기 (Selenium)</h2>
        <label>시간표 URL</label>
        <input id="webUrl" type="text" placeholder="예) https://everytime.kr/@닉네임 또는 https://example.com/timetable" />
        <div class="hint">에브리타임은 반드시 <b>/@… 공유 링크</b>를 사용하세요. (앱/웹: 시간표 → 공유 → 링크 복사)</div>

        <div class="row" style="margin-top:6px">
          <span class="note">파싱 모드</span>
          <label class="chip"><input type="radio" name="mode" value="auto" checked /> auto</label>
          <label class="chip"><input type="radio" name="mode" value="dom" /> dom</label>
          <label class="chip"><input type="radio" name="mode" value="text" /> text</label>
          <label class="chip"><input type="radio" name="mode" value="css" /> css</label>
        </div>

        <div class="grid" style="margin-top:6px">
          <div><label>시작 시각(시간) [css]</label><input id="webStartHour" type="number" min="0" max="23" value="9" /></div>
          <div><label>30분당 픽셀(px) [css]</label><input id="webPx30" type="number" value="25" /></div>
          <div><label>top 오프셋(px) [css]</label><input id="webTopOffset" type="number" value="450" /></div>
        </div>

        <details>
          <summary>선택자 고급 설정 [css/dom]</summary>
          <p class="note">쉼표(,)로 여러 후보를 적으면 모두 시도합니다. 비워두면 기본 후보들을 자동 시도합니다.</p>
          <label>헤더(요일) 선택자(들)</label>
          <input id="selHead" type="text" placeholder=".tablehead td,.fc-col-header th,thead th,.rbc-time-header" />
          <label>본문 컨테이너 선택자(들)</label>
          <input id="selBody" type="text" placeholder=".tablebody,.fc-timegrid,.rbc-time-content,.weekly-schedule" />
          <label>블록 선택자(들)</label>
          <input id="selBlock" type="text" placeholder=".subject,.fc-event,.rbc-event,[data-event]" />
        </details>

        <details>
          <summary>로그인 도움 모드</summary>
          <p class="note">로그인이 필요한 사이트는 이 모드를 켜면 <b>브라우저 창</b>이 열립니다. 창에서 로그인/리캡챠 통과 후 시간표 페이지를 열어두면 자동으로 파싱합니다.</p>
          <div class="grid">
            <div><input id="interactiveLogin" type="checkbox" /> <label for="interactiveLogin">브라우저 열기(로그인 도와줌)</label></div>
            <div><label>대기(초)</label><input id="waitLogin" type="number" min="10" value="120" /></div>
          </div>
        </details>

        <div class="actions">
          <button id="btnParseWeb">가져와서 변환</button>
          <button id="btnDiagnose">진단</button>
          <button id="btnApplyWeb" disabled>결과를 입력 칸에 반영</button>
        </div>

        <label>결과 (수동 입력 포맷)</label>
        <textarea id="webResult" rows="8" placeholder="(가져오기 후 결과가 여기에 표시됩니다)"></textarea>

        <details>
          <summary>진단 결과</summary>
          <pre id="diagOut" class="mono"></pre>
        </details>
      </div>
    </section>

    <section class="card">
      <h2>미리보기</h2>
      <div id="preview" class="preview"></div>
    </section>
  </main>

  <script>
    const $ = s => document.querySelector(s);
    $('#apiBase').value = localStorage.getItem('apiBase') || 'http://127.0.0.1:8000';
    function API_BASE(){ return ($('#apiBase').value || 'http://127.0.0.1:8000').replace(/\/$/, ''); }
    $('#btnSaveApi').onclick = ()=>{ localStorage.setItem('apiBase', $('#apiBase').value || 'http://127.0.0.1:8000'); $('#pingMsg').textContent='저장됨'; setTimeout(()=>$('#pingMsg').textContent='',1500); };
    $('#btnPing').onclick = async ()=>{
      $('#pingMsg').textContent = '핑 중...';
      try{
        const r = await fetch(API_BASE() + '/health');
        if(!r.ok) throw new Error(await r.text());
        const j = await r.json();
        $('#pingMsg').innerHTML = `<span class="ok">연결 OK</span> (v${j.version})`;
      }catch(e){ $('#pingMsg').innerHTML = `<span class="bad">연결 실패</span>`; }
    };

    // 탭
    const tabManual = $('#tabManual'), tabUploadOcr = $('#tabUploadOcr'), tabWeb = $('#tabWeb');
    const panelManual = $('#panelManual'), panelUploadOcr = $('#panelUploadOcr'), panelWeb = $('#panelWeb');
    function setTab(which){
      [tabManual,tabUploadOcr,tabWeb].forEach(t=>t.classList.remove('active'));
      [panelManual,panelUploadOcr,panelWeb].forEach(p=>p.classList.add('hide'));
      if(which==='manual'){ tabManual.classList.add('active'); panelManual.classList.remove('hide'); }
      if(which==='upload'){ tabUploadOcr.classList.add('active'); panelUploadOcr.classList.remove('hide'); }
      if(which==='web'){ tabWeb.classList.add('active'); panelWeb.classList.remove('hide'); }
    }
    tabManual.onclick = ()=>setTab('manual');
    tabUploadOcr.onclick = ()=>setTab('upload');
    tabWeb.onclick = ()=>setTab('web');

    function parseHolidays(s){ return (s||"").split(',').map(x=>x.trim()).filter(Boolean); }
    function bodyCommon(){
      return {
        text: $('#inputText').value,
        start_date: $('#startDate').value,
        end_date: $('#endDate').value,
        pattern: "{SUBJECT}/주차{WEEK2}/{WEEKDAY_KO}_{MM}-{DD}",
        holidays: parseHolidays($('#holidays').value),
        write_meta: $('#writeMeta').checked
      };
    }

    // 미리보기/ZIP
    $('#btnPreview').onclick = async ()=>{
      $('#errors').hidden = true; $('#errors').textContent = '';
      try{
        const res = await fetch(API_BASE() + '/preview', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(bodyCommon())
        });
        if(!res.ok) throw new Error(await res.text());
        const data = await res.json();
        const lines = (data.sample||[]).join('\n');
        $('#preview').textContent = (lines || '(생성 결과 없음)') +
          (data.count>data.sample.length ? `\n... 외 ${data.count - data.sample.length}개` : '');
      }catch(e){
        $('#errors').hidden = false; $('#errors').textContent = (e.message||'') || '요청 실패';
      }
    };
    $('#btnDownload').onclick = async ()=>{
      $('#errors').hidden = true; $('#errors').textContent = '';
      try{
        const res = await fetch(API_BASE() + '/generate.zip', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(bodyCommon())
        });
        if(!res.ok) throw new Error(await res.text());
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'generated_folders.zip';
        a.click();
        URL.revokeObjectURL(a.href);
      }catch(e){
        $('#errors').hidden = false; $('#errors').textContent = (e.message||'') || '요청 실패';
      }
    };

    // OCR
    $('#btnParseOcr').onclick = async ()=>{
      const f = $('#fileInputOcr').files[0];
      if(!f){ alert('파일을 선택하세요.'); return; }
      $('#ocrResult').value = '(파싱 중...)'; $('#btnApplyOcr').disabled = true;
      try{
        const fd = new FormData(); fd.append('file', f);
        const res = await fetch(API_BASE() + '/ocr/parse', { method:'POST', body: fd });
        if(!res.ok) throw new Error(await res.text());
        const data = await res.json();
        $('#ocrResult').value = data.entries_text || '';
        $('#btnApplyOcr').disabled = !$('#ocrResult').value;
      }catch(e){
        $('#ocrResult').value = ''; alert('파싱 실패: ' + (e.message || e));
      }
    };
    $('#btnApplyOcr').onclick = ()=>{ $('#inputText').value = $('#ocrResult').value || ''; setTab('manual'); };

    // 웹 파싱
    const getMode = ()=>{ const r = document.querySelector('input[name="mode"]:checked'); return r ? r.value : 'auto'; };
    function webSelectorsPayload(){
      return {
        head_selector: ($('#selHead').value.trim() || null),
        body_selector: ($('#selBody').value.trim() || null),
        block_selector: ($('#selBlock').value.trim() || null),
      };
    }
    $('#btnParseWeb').onclick = async ()=>{
      const url = $('#webUrl').value.trim();
      if(!url){ alert('URL을 입력하세요.'); return; }
      $('#webResult').value = '(가져오는 중...)'; $('#btnApplyWeb').disabled = true;
      try{
        const body = {
          url,
          mode: getMode(),
          start_hour: ($('#webStartHour').value ? parseInt($('#webStartHour').value, 10) : 9),
          px_per_30: ($('#webPx30').value ? parseInt($('#webPx30').value, 10) : 25),
          top_offset: ($('#webTopOffset').value ? parseInt($('#webTopOffset').value, 10) : 450),
          interactive_login: $('#interactiveLogin').checked,
          wait_login_seconds: ($('#waitLogin').value ? parseInt($('#waitLogin').value, 10) : 120),
          ...webSelectorsPayload()
        };
        const res = await fetch(API_BASE() + '/web/parse', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        if(!res.ok) throw new Error(await res.text());
        const data = await res.json();
        $('#webResult').value = data.entries_text || '';
        $('#btnApplyWeb').disabled = !$('#webResult').value;
      }catch(e){
        $('#webResult').value = ''; alert('가져오기 실패: ' + (e.message || e));
      }
    };
    $('#btnApplyWeb').onclick = ()=>{ $('#inputText').value = $('#webResult').value || ''; setTab('manual'); };

    // 진단
    $('#btnDiagnose').onclick = async ()=>{
      const url = $('#webUrl').value.trim();
      if(!url){ alert('URL을 입력하세요.'); return; }
      $('#diagOut').textContent = '(진단 중...)';
      try{
        const body = { url, max_samples: 30, for_mode: getMode() };
        const res = await fetch(API_BASE() + '/web/diagnose', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        if(!res.ok) throw new Error(await res.text());
        const data = await res.json();
        $('#diagOut').textContent = JSON.stringify(data, null, 2);
      }catch(e){
        $('#diagOut').textContent = '진단 실패: ' + (e.message || e);
      }
    };
  </script>
</body>
</html>
